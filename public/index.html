let currentId = null; // Guardamos el ID del registro actual
const alertSfx = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

async function syncHoo() {
    try {
        const r = await fetch('/precio-actual');
        const d = await r.json();
        
        // 1. COMPARACIÓN CRÍTICA: ¿Es un registro nuevo?
        if (currentId !== null && d.id === currentId) {
            console.log("Sin cambios > 2%. Manteniendo estado actual.");
            return; // Si el ID es igual, no hacemos NADA visual
        }

        // 2. Si llegamos aquí, es porque hay un nuevo registro (Salto del 2%)
        currentId = d.id; 
        
        // Actualizar Textos
        document.getElementById('bcv').innerText = d.precio_bcv;
        document.getElementById('usdt').innerText = d.precio_usdt;
        document.getElementById('brecha').innerText = d.brecha_porcentaje;
        document.getElementById('status-label').innerText = `STATUS: ${d.status.toUpperCase()}`;

        // Banner Inteligente: Solo si es devaluación o apreciación
        const banner = document.getElementById('ticker-wrap');
        banner.style.display = (d.status === 'estable' || d.status === 'inicializado') ? 'none' : 'block';

        // Animación Círculo
        const gapVal = parseFloat(d.brecha_porcentaje.replace(',', '.'));
        document.getElementById('gap-circle').style.strokeDashoffset = 440 - (440 * Math.min(gapVal, 30) / 30);

        // Disparar Alerta (Solo si no es la primera carga)
        if (currentId !== null) {
            alertSfx.play();
            if (Notification.permission === "granted") {
                new Notification("HOOLE: MOVIMIENTO DETECTADO", { 
                    body: `La brecha ha cambiado a ${d.brecha_porcentaje}` 
                });
            }
        }
    } catch (e) { console.log("Reintentando conexión..."); }
}

setInterval(syncHoo, 30000); // Consulta cada 30 seg, pero solo refresca visualmente si hay cambio > 2%
syncHoo();
